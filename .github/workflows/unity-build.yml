name: unity-build

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Clean Disk Space
        run: |
          echo "ðŸ§¹ Cleaning up disk space..."
          docker system prune -a -f || true
          docker volume prune -f || true
          docker builder prune -a -f || true
          sudo rm -rf /opt/unity || true
          sudo rm -rf ~/.cache/unity3d || true
          df -h

      - name: Install Android SDK
        run: |
          echo "ðŸ“¥ Installing Android SDK..."
          export ANDROID_HOME=$HOME/android-sdk
          export ANDROID_SDK_ROOT=$ANDROID_HOME
          mkdir -p $ANDROID_HOME/cmdline-tools
          cd $ANDROID_HOME/cmdline-tools
          curl -o sdk-tools.zip https://dl.google.com/android/repository/commandlinetools-linux-10406996_latest.zip
          unzip sdk-tools.zip -d latest
          rm sdk-tools.zip
          if [ -d "latest/cmdline-tools" ]; then
            mv latest/cmdline-tools/* latest/
            rm -rf latest/cmdline-tools
          fi
          echo "export ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
          echo "export ANDROID_SDK_ROOT=$ANDROID_HOME" >> $GITHUB_ENV
          echo "export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH" >> $GITHUB_ENV
          echo "âœ… Android SDK installed!"

      - name: Install Android Build Tools
        run: |
          source $GITHUB_ENV
          echo "âœ… Updating SDK tools..."
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --update || echo "âŒ Update failed"
          echo "âœ… Accepting SDK licenses..."
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || echo "âŒ License acceptance failed "
          echo "âœ… Installing Build Tools..."
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "platforms;android-34" "build-tools;34.0.0" "platform-tools" || echo "âŒ Installation failed"

      - name: Build Android APK with Unity
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          targetPlatform: Android
          androidExportType: androidPackage
          androidSymbolType: none
          projectPath: .
        continue-on-error: false

      - name: Debug Build Directory Structure
        run: |
          echo "ðŸ” Listing build directory structure..."
          ls -R build/ || echo "build/ dizini bulunamadÄ±"

      - name: Check APK Existence
        run: |
          echo "ðŸ” Searching for APK files..."
          find . -name "*.apk" -print
          if ls build/Android/*.apk 1> /dev/null 2>&1; then
            echo "âœ… APK file found in build/Android."
          else
            echo "âŒ No APK file found in build/Android."
            exit 1
          fi

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Build-Android
          path: build/Android/*.apk
          retention-days: 5

      - name: Send Slack Notification with APK
        run: |
          echo "ðŸ“¤ APK dosyasÄ± Slack'e yÃ¼kleniyor..."

          # APK dosyasÄ±nÄ± bul
          FILE_PATH=$(find build/Android/ -type f -name "*.apk" | head -n 1)

          if [ -z "$FILE_PATH" ]; then
            echo "âŒ APK dosyasÄ± bulunamadÄ±!"
            exit 1
          fi

          FILE_NAME=$(basename "$FILE_PATH")

          # Dosya boyutunu al (stat komutunu kullanarak)
          if command -v stat &> /dev/null; then
            FILE_SIZE=$(stat -c%s "$FILE_PATH")
          else
            FILE_SIZE=$(wc -c < "$FILE_PATH" | tr -d ' ')
          fi

          if [ -z "$FILE_SIZE" ] || [ "$FILE_SIZE" -le 0 ]; then
            echo "âŒ GeÃ§erli dosya boyutu alÄ±namadÄ±!"
            exit 1
          fi

          echo "ðŸ” Dosya AdÄ±: $FILE_NAME"
          echo "ðŸ“¦ Dosya Boyutu: $FILE_SIZE bytes"

          # Slack'ten upload URL ve file ID al
          JSON_PAYLOAD=$(jq -n --arg filename "$FILE_NAME" --argjson length "$FILE_SIZE" '{filename: $filename, length: $length}')
          echo "ðŸ›  GÃ¶nderilen JSON Payload: $JSON_PAYLOAD"

          UPLOAD_RESPONSE=$(curl -s -X POST "https://slack.com/api/files.getUploadURLExternal" \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -H "Content-Type: application/json; charset=utf-8" \
            --data "$JSON_PAYLOAD")

          echo "ðŸ›  API YanÄ±tÄ±: $UPLOAD_RESPONSE"

          # JSON'dan deÄŸerleri Ã§ek
          UPLOAD_URL=$(echo "$UPLOAD_RESPONSE" | jq -r '.upload_url')
          FILE_ID=$(echo "$UPLOAD_RESPONSE" | jq -r '.file_id')

          # Hata kontrolÃ¼
          if [ -z "$UPLOAD_URL" ] || [ "$UPLOAD_URL" == "null" ]; then
            echo "âŒ Slack yÃ¼kleme URL'si alÄ±namadÄ±! Hata: $UPLOAD_RESPONSE"
            exit 1
          fi

          echo "ðŸ”„ Dosya yÃ¼kleniyor..."
          curl -X POST -F file=@"$FILE_PATH" "$UPLOAD_URL"

          echo "âœ… YÃ¼kleme tamamlandÄ±, Slack'e bildiriliyor..."
          curl -X POST "https://slack.com/api/files.completeUploadExternal" \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -H "Content-Type: application/json; charset=utf-8" \
            --data "$(jq -n --arg file_id "$FILE_ID" --arg channel_id "#auto_build" --arg initial_comment "ðŸš€ *Unity Build TamamlandÄ±!* âœ… Ä°ÅŸte APK dosyan! ðŸ“±" '{file_id: $file_id, channel_id: $channel_id, initial_comment: $initial_comment}')"
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
     
      
     
